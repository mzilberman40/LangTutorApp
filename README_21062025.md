# Langs2Brain API - Техническая документация

**Версия: 21.06.2025**

## 1. Обзор

Langs2Brain — это бэкенд-сервис для приложения по изучению языков. Его ядро — создание и ведение персонализированных словарей, где рутинные лингвистические задачи (анализ, перевод, проверка) автоматизированы с помощью LLM, работающих в асинхронном режиме.

Этот документ описывает архитектуру, ключевые концепции и руководство по использованию API.

## 2. Технологический стек

* **Бэкенд:** Python, Django, Django REST Framework
* **Асинхронные задачи:** Celery, Redis
* **База данных:** SQLite (разработка), PostgreSQL (продакшен)
* **Контейнеризация:** Docker, Docker Compose
* **Документация API:** `drf-spectacular` (OpenAPI 3.0)

## 3. Запуск и использование

1.  **Запуск:** После настройки `.env` файла, используйте `docker compose up --build`.
2.  **Документация API:** Всегда актуальная интерактивная документация доступна по адресу `http://127.0.0.1:8000/api/docs/` после запуска проекта. Она является основным источником информации по эндпоинтам, параметрам и моделям данных.
3.  **Команды управления:** Выполняйте команды Django через `docker compose exec web python manage.py <команда>`.

## 4. Ключевые концепции и архитектура

### 4.1. Асинхронная архитектура "Принять и обработать"

Все ресурсоемкие операции, связанные с LLM, вынесены в фоновые задачи Celery. Это обеспечивает мгновенный отклик API.

**Рабочий процесс:**
1.  Клиент отправляет запрос на долгое действие (например, `POST /api/phrases/{id}/enrich/`).
2.  API немедленно валидирует запрос и, если он корректен, ставит задачу в очередь Celery.
3.  API **мгновенно** отвечает клиенту статусом `202 Accepted` и возвращает `task_id`.
4.  Клиент может отслеживать статус выполнения задачи, периодически опрашивая эндпоинт `GET /api/task-status/{task_id}/`.

### 4.2. Философия валидации: "Информируй, но не изменяй"

Система никогда не изменяет втихую данные, введенные пользователем. Вместо этого она использует механизм асинхронной валидации для предоставления обратной связи.

**Поля для валидации:**
* `validation_status`: Статус проверки (`unverified`, `valid`, `mismatch`, `failed`).
* `validation_notes`: Текстовое поле, в которое LLM записывает свои выводы (например, "Grammatically correct, but sounds unnatural" или "Language mismatch detected").

Этот подход уважает данные пользователя, но обогащает их ценными лингвистическими подсказками, превращая сервис в умного ассистента.

### 4.3. Основные сущности и их жизненный цикл

#### `LexicalUnit` (Словарная единица)
Атомарная единица словаря. Определяется уникальной комбинацией `lemma`, `language`, `lexical_category` и `part_of_speech`.

* **`lexical_category`**: Структурный тип (`SINGLE_WORD`, `PHRASAL_VERB`, `IDIOM`).
* **`part_of_speech`**: Грамматическая функция (`noun`, `verb`). Для составных единиц — доминантная часть речи всего выражения.

**Жизненный цикл:**
1.  **Создание:** Пользователь может создать LU, указав только лемму.
2.  **Обогащение (`/enrich/`):** Асинхронная задача находит все возможные варианты частей речи для данной леммы, создавая в базе данных отдельные, четко определенные объекты `LexicalUnit`.
3.  **Перевод (`/translate/`):** Асинхронная задача переводит конкретную LU на другой язык, создавая новые LU для перевода и связывая их.

#### `Phrase` (Фраза-пример)
Иллюстративная фраза. Изначально может быть создана только с текстом и языком.

**Жизненный цикл:**
1.  **Создание:** Пользователь добавляет фразу. Поля `cefr`, `category` и `validation_status` имеют значения по умолчанию.
2.  **Обогащение (`/enrich/`):** Асинхронная задача анализирует фразу, заполняет пустые поля (`cefr`, `category`) и проводит полную валидацию, записывая результат в `validation_status` и `validation_notes`.

#### `LexicalUnitTranslation` и `PhraseTranslation`
Модели-связки, представляющие собой отношения перевода между соответствующими сущностями.